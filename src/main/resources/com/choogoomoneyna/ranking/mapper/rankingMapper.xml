<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.choogoomoneyna.choogoomoneyna_be.ranking.mapper.RankingMapper">

    <!-- ResultMap: DB 결과를 RankingVO에 매핑 -->
    <resultMap id="RankingResultMap" type="com.choogoomoneyna.choogoomoneyna_be.ranking.vo.RankingVO">
        <id property="userId" column="user_id" />
        <result property="previousRanking" column="previous_ranking" />
        <result property="currentRanking" column="current_ranking" />
    </resultMap>

    <!-- 랭킹 정보 삽입 -->
    <insert id="insertRanking" parameterType="com.choogoomoneyna.choogoomoneyna_be.ranking.vo.RankingVO">
        INSERT INTO rankings (user_id, previous_ranking, current_ranking)
        VALUES (#{userId}, #{previousRanking}, #{currentRanking})
    </insert>

    <!-- 특정 유저의 현재 랭킹 변경 -->
    <update id="updateCurrentRankingByUserId">
        UPDATE rankings
        SET current_ranking = #{currentRanking}
        WHERE user_id = #{userId}
    </update>

    <!-- 특정 유저의 랭킹 정보 조회 -->
    <select id="findRankingByUserId" parameterType="long"
            resultMap="RankingResultMap">
        SELECT user_id, previous_ranking, current_ranking
        FROM rankings
        WHERE user_id = #{userId}
    </select>

    <!-- 특정 유저의 현재 랭킹만 조회 -->
    <select id="getCurrentRanking" parameterType="long" resultType="int">
        SELECT current_ranking
        FROM rankings
        WHERE user_id = #{userId}
    </select>

    <!-- 이번 주 랭킹을 저번 주 랭킹으로 이월 -->
    <update id="rolloverWeeklyRankings">
        UPDATE rankings
        SET previous_ranking = current_ranking
    </update>

    <update id="batchUpdateCurrentRanks">
        UPDATE rankings
        SET current_ranking = CASE user_id
        <foreach collection="rankingList" item="rank">
            WHEN #{rank.userId} THEN #{rank.currentRanking}
        </foreach>
        ELSE current_ranking
        END
        WHERE user_id IN
        <foreach collection="rankingList" item="rank" open="(" separator="," close=")">
            #{rank.userId}
        </foreach>
    </update>




</mapper>
